events {
    worker_connections 1024;
}

http {
    upstream laravel_app {
        server app:9000;
    }

    server {
        listen 80;
        server_name localhost;
        root /var/www;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header X-XSS-Protection "1; mode=block";

        # Customer app routes
        location / {
            alias /var/www/customer/public;
            try_files $uri $uri/ /index.php?$query_string;

            location ~ \.php$ {
                fastcgi_pass laravel_app;
                fastcgi_param SCRIPT_FILENAME $request_filename;
                include fastcgi_params;
                fastcgi_param APP_ENV customer;
            }
        }

        # Admin app routes
        location /admin {
            alias /var/www/admin/public;
            try_files $uri $uri/ /index.php?$query_string;

            location ~ \.php$ {
                fastcgi_pass laravel_app;
                fastcgi_param SCRIPT_FILENAME $request_filename;
                include fastcgi_params;
                fastcgi_param APP_ENV admin;
            }
        }

        # Static files
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Deny access to sensitive files
        location ~ /\. {
            deny all;
        }
    }
}