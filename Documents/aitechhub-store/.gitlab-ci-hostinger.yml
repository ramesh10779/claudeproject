# GitLab CI/CD for Hostinger Deployment
# Deploy AITechHub Store to Hostinger via SFTP/FTP

image: php:8.2

stages:
  - build
  - deploy

variables:
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .composer-cache/
    - customer/vendor/
    - customer/node_modules/

# Build Customer App
build:customer:
  stage: build
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq git curl libzip-dev zip unzip nodejs npm
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - docker-php-ext-install zip
  script:
    - cd customer
    - cp .env.example .env
    - composer install --no-dev --optimize-autoloader --no-interaction
    - npm ci
    - npm run build
    - php artisan config:clear
    - php artisan route:clear
    - php artisan view:clear
  artifacts:
    paths:
      - customer/
    expire_in: 1 hour

# Deploy to Hostinger via SFTP
deploy:hostinger:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build:customer
  only:
    - main
    - master
  before_script:
    - apk add --no-cache lftp openssh-client
  script:
    # Create deployment package
    - cd customer

    # Create production .env file from GitLab variables
    - |
      cat > .env << EOF
      APP_NAME="AITechHub Store"
      APP_ENV=production
      APP_KEY=${APP_KEY}
      APP_DEBUG=false
      APP_URL=https://aitechhub.store

      LOG_CHANNEL=stack
      LOG_DEPRECATIONS_CHANNEL=null
      LOG_LEVEL=error

      DB_CONNECTION=mysql
      DB_HOST=localhost
      DB_PORT=3306
      DB_DATABASE=${DB_DATABASE}
      DB_USERNAME=${DB_USERNAME}
      DB_PASSWORD=${DB_PASSWORD}

      BROADCAST_DRIVER=log
      CACHE_DRIVER=file
      FILESYSTEM_DISK=local
      QUEUE_CONNECTION=sync
      SESSION_DRIVER=file
      SESSION_LIFETIME=120

      MAIL_MAILER=smtp
      MAIL_HOST=mailhog
      MAIL_PORT=1025
      MAIL_USERNAME=null
      MAIL_PASSWORD=null
      MAIL_ENCRYPTION=null
      MAIL_FROM_ADDRESS="hello@aitechhub.store"
      MAIL_FROM_NAME="AITechHub Store"

      ADMIN_API_URL=http://localhost:8000/api
      ADMIN_API_KEY=${ADMIN_API_KEY}
      EOF

    # Deploy via LFTP (FTP/SFTP)
    - |
      lftp -u $HOSTINGER_FTP_USER,$HOSTINGER_FTP_PASS -e "
      set ftp:ssl-allow no;
      set ssl:verify-certificate no;
      open $HOSTINGER_FTP_HOST;
      mirror --reverse --delete --verbose --exclude .git/ --exclude storage/logs/ --exclude storage/framework/cache/ --exclude node_modules/ --exclude tests/ . /public_html/;
      bye
      "

    # Run post-deployment commands via SSH (if available)
    - |
      if [ -n "$HOSTINGER_SSH_KEY" ]; then
        mkdir -p ~/.ssh
        echo "$HOSTINGER_SSH_KEY" | base64 -d > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh -o StrictHostKeyChecking=no $HOSTINGER_SSH_USER@$HOSTINGER_SSH_HOST << 'EOF'
          cd /public_html
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan migrate --force
      EOF
      fi
  environment:
    name: production
    url: https://aitechhub.store
