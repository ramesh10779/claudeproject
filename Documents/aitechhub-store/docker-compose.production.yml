version: '3.8'

# ============================================
# AITechHub Store - Production Configuration
# ============================================
# Last Updated: 2025-10-09
# Features:
# - Multi-stage optimized containers
# - Database hardening with security policies
# - Automatic SSL certificate generation
# - Health checks and auto-restart
# - Volume persistence
# - Network isolation
# ============================================

services:
  # ============================================
  # Database - Hardened MySQL 8.0
  # ============================================
  database:
    build:
      context: .
      dockerfile: docker/database/Dockerfile
    container_name: aitechhub-db-prod
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-changeme_root_password}
      MYSQL_DATABASE: ${DB_DATABASE:-aitechhub_store}
      MYSQL_USER: ${DB_USERNAME:-aitechhub}
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme_production_password}
      TZ: UTC
    volumes:
      - db_data:/var/lib/mysql
      - db_logs:/var/log/mysql
      - ./docker/database/init:/docker-entrypoint-initdb.d:ro
      - ./docker/database/backups:/backups
    networks:
      - backend
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-changeme_root_password}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - SETUID
      - SETGID

  # ============================================
  # Admin Backend - Laravel 12 Application
  # ============================================
  admin:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
      args:
        APP_ENV: production
    container_name: aitechhub-admin-prod
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    environment:
      APP_NAME: "AITechHub Admin"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: https://admin.aitechhub.store
      DB_CONNECTION: mysql
      DB_HOST: database
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-aitechhub_store}
      DB_USERNAME: ${DB_USERNAME:-aitechhub}
      DB_PASSWORD: ${DB_PASSWORD:-changeme_production_password}
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./admin:/var/www/html
      - admin_storage:/var/www/html/storage
      - admin_cache:/var/www/html/bootstrap/cache
      - admin_logs:/var/log/php
    networks:
      - backend
      - frontend
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID

  # ============================================
  # Customer Frontend - Laravel 12 Application
  # ============================================
  customer:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      args:
        APP_ENV: production
    container_name: aitechhub-customer-prod
    restart: unless-stopped
    depends_on:
      database:
        condition: service_healthy
    environment:
      APP_NAME: "AITechHub Store"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: https://aitechhub.store
      DB_CONNECTION: mysql
      DB_HOST: database
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-aitechhub_store}
      DB_USERNAME: ${DB_USERNAME:-aitechhub}
      DB_PASSWORD: ${DB_PASSWORD:-changeme_production_password}
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ADMIN_API_URL: http://admin:8001/api
      ADMIN_API_KEY: ${ADMIN_API_KEY:-your-secure-api-key-change-this}
    volumes:
      - ./customer:/var/www/html
      - customer_storage:/var/www/html/storage
      - customer_cache:/var/www/html/bootstrap/cache
      - customer_logs:/var/log/php
    networks:
      - backend
      - frontend
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID

  # ============================================
  # SSL/Reverse Proxy - Nginx with Let's Encrypt
  # ============================================
  ssl:
    build:
      context: .
      dockerfile: docker/ssl/Dockerfile
    container_name: aitechhub-ssl-prod
    restart: unless-stopped
    depends_on:
      - admin
      - customer
    environment:
      DOMAIN: ${DOMAIN:-aitechhub.store}
      SSL_EMAIL: ${SSL_EMAIL:-admin@aitechhub.store}
      STAGING: ${SSL_STAGING:-0}
    volumes:
      - ./docker/ssl/nginx-ssl.conf:/etc/nginx/nginx.conf:ro
      - ssl_certs:/etc/nginx/ssl
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
      - ssl_logs:/var/log/nginx
    networks:
      - frontend
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE

  # ============================================
  # Redis - Cache & Session Store
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: aitechhub-redis-prod
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme_redis_password} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - backend
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

# ============================================
# Networks
# ============================================
networks:
  backend:
    driver: bridge
    internal: true
  frontend:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  # Database
  db_data:
    driver: local
  db_logs:
    driver: local

  # Admin
  admin_storage:
    driver: local
  admin_cache:
    driver: local
  admin_logs:
    driver: local

  # Customer
  customer_storage:
    driver: local
  customer_cache:
    driver: local
  customer_logs:
    driver: local

  # SSL
  ssl_certs:
    driver: local
  letsencrypt:
    driver: local
  certbot_webroot:
    driver: local
  ssl_logs:
    driver: local

  # Redis
  redis_data:
    driver: local
